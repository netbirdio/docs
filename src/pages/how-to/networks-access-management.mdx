# Networks access management

<Note>
    TLDR; Access to Network Resources is managed differently for services running directly
    on the Routing Peer's machine/VM/container than for services running 
    externally to the **currently selected** Routing Peer.

    Inactive Routing Peers in High Availability setup are also considered external resources!

</Note>

This document aims to explain how to correctly grant access to resources running outside the NetBird network and
why you might encounter hard to comprehend behaviours when accessing them.
We have seen various flavors of following issues:

1. I have only granted ICMP access to the Network, but I can access HTTPS services running on one of the IP addresses.
2. I have granted full access to the Network, but I cannot access anything on one of the IP addresses,
3. I did not grant any access to the Network, but for some reason this one IP is fully accessible.
   Hint: sometimes you don't consider ICMP/DNS "granting an access" and it flies under the radar.
4. Right now I cannot access `IP.1`, other times it's `IP.2` or `IP.3` having issues,
5. I had coworkers reporting trouble accessing `IP.123`, while others cannot access `IP.45`.
   Hint: different Routing Peer might be closest to different set of users.
6. I am giving access to a domain name with a Network Resource. I have confirmed the DNS query resolves, but there is
   no access to the resulting IP address.

## The primary mechanism involved in policing Networks traffic

To manage access to and through the Routing Peers in Networks it is essential to understand that in the
standard operating system networking model IP addresses assigned directly to the device are handled differently and
independently of addresses behind it (aka routed/forwarded addresses).
This currently also holds true in context of NetBird's Networks and Routing Peers access management:

- IP address attached directly to any of the client's local interfaces is NOT considered being routed/forwarded
  and is policed by the device's rules. In context of NetBird those are the Access Policies naming any of
  the Routing Peer's Groups as the destination:
  - this holds true especially when the address overlaps with the routed network's range,
- all the other IP addresses from the network range are considered being routed/forwarded and are governed by a separate
  set of rules. In NetBird context they are governed by Access Policies naming Resources (or their Groups) as the
  destination.

## General rules

Here are some general rules resulting from above mechanism:

- access to **Resources** does not require access to the **Routing Peer** itself,
  - the Resource's Group needs to be mentioned in Access Policy's destination explicitly:
    - `All` Group does not cover Resources, unless it is explicitly assigned to those,
    - it is generally advised not to use the `All` group in the context of Networks,
- access to the **Routing Peer**'s local IP address needs to be explicitly allowed:
  - granting access to Resource will establish connectivity to the Routing Peer (eg: in `netbird status -d`), but
    traffic destined to any of the Routing Peer's local IP addresses will be rejected,
- the Resource policy can have completely different scope than the Routing Peer policy,
  - access to the Routing Peer is not limited by the Resource policies in any way,
  - it is possible to grant broader or more restricted access to the Routing Peer's IP address
    than to the rest of the routed network,
- you can access _inactive_ Routing Peers on the same Network by their "local" IP addresses, because they are now
  effectively remote Resource,
- domain-based (as opposed to subnet-based) Resources still resolve to and create routes for a set of one or
  more IP addresses (`/32` subnets), which in turn conform to the same rules and need to be planned accordingly:
  - if it happens to resolve to the IP address of the Routing Peer it will need to be allowed by a policy mentioning
    Routing Peers as destination,

## Visualising access

In this example we are granting access:

1. from the User's laptop (belonging to **User's Group**,
2. to the `192.168.1.0/24` Network Resource assigned to the **Resource's Group**
   (there is a **Server** running in this network)
3. through 2 Routing Peer's belonging to **Routing Peer's Group** placed directly inside the same routed network

Such access is governed by 2 separate Access Policies:

1. a **Router Policy** from **User's Group** to **Routing Peer's Group** represented by a solid orange arrows
2. a **Resource Policy** from **User's Group** to **Resource's Group** represented by a green dashed arrows

When the `router-1` is acting as the Routing Peer:
<p>
    <img src="/docs-static/img/how-to-guides/network-resource-policies-router-1.drawio.svg" alt="routing-peer-policies" className="imagewrapper-big"/>
</p>

When the `router-2` is acting as the Routing Peer:
<p>
    <img src="/docs-static/img/how-to-guides/network-resource-policies-router-2.drawio.svg" alt="routing-peer-policies" className="imagewrapper-big"/>
</p>

### The **Router Policy**

- always governs access to both of the Routing Peer's NetBird IP addresses,
- only governs access to the currently active Routing Peer's local IP (external to NetBird),
  - there can only ever be one active at a time,

### The **Resource Policy**

- always governs access to the **Server**,
- governs access to the inactive Routing Peer's local IP,
  - there can be any number of inactive Routing Peers,

### Example: access granted only to the Resource

Having a single policy allowing access to Resources, but not to the Routing Peer would result in following behaviors:

- connecting through `router-1` you will be able to access the`192.168.1.0/24` subnet
  except for a single IP `192.168.1.1`(Routing Peer's local address),
- connecting through `router-2` you won't be able to access `192.168.1.2`,

### Example: restrictive Resource access combined with permissive Routing Peer access

Having a Resource policy scoped to ICMP and a Routing Peer policy scoped to TCP 443 (HTTPS) would result in following
behaviors:

- connecting through `router-1` you will be able to ping (and nothing else) the `192.168.1.0/24` subnet
  except for a single IP `192.168.1.1`. You will not be able to ping it, but instead you will be able to
  access all of HTTPS services running on this specific Routing Peer,
- connecting through `router-2` you won't be able to ping `192.168.1.2`, but will be able to access HTTPS services,
- connecting through `router-3` you won't be able to ping `192.168.1.3`, but will be able to access HTTPS services,

### Security caveats

Combining very restrictive Resource policies with broad Routing Peer policies might result in what some users
would at the first glance consider security vulnerabilities.

This can be particularly unexpected when the Routing Peer is handling multiple subnets with different Groups or
permission levels assigned. Granting access to the Routing Peer will grant access to all the services running
on the Routing Peer itself for all the routed subnets, even if one (or all) of the subnets have very
restrictive/harmless Resource policies in place:

- a potentially harmless Resource policy will make it advertised to the clients, without granting any meaningful access,
- a permissive Routing Peer policy can grant _full_ access to the IP address from the routed network,

By combining above two policies seemingly unrelated and harmless policies,
you can unexpectedly grant complete access to the Routing Peer's local IP address:

- if you omitted the Resource policy, the route would not be advertised and therefore never be allowed to pass through
  the WireGuard connection,
- if you omitted the Routing Peer policy, you would not be able to access that single IP address at all,
