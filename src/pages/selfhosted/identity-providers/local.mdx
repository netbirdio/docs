# Local User Management

NetBird's Management service includes built-in user management, allowing you to create and manage local users directly without requiring an external identity provider. This functionality is powered by an embedded [Dex](https://dexidp.io/) server.

Starting with version 0.62, NetBird **no longer requires an external identity provider**. The Management service now supports creating and managing local users directly, so you can get started without setting up Zitadel, Keycloak, or any other IdP.

With local user management, you can:

- **Create local users** directly from the NetBird Dashboard
- **Add external identity providers** (Google, Microsoft, Okta, etc.) through the Dashboard UI
- **Configure multiple IdPs** simultaneously, users see all providers as login options
- **Simplify your deployment** with fewer containers and reduced resource requirements
- **Get started faster** with no additional IdP setup required

<Note>
Local user management is powered by an embedded [Dex](https://dexidp.io/) server running within the NetBird Management service, requiring no additional containers or databases.
</Note>

[Get Started →](/selfhosted/selfhosted-quickstart)

## When to Use Local Users

Local user management is ideal for:

| Use Case | Why Local Users Work |
|----------|----------------------|
| **Homelabs** | Simple setup, minimal resources, no external dependencies |
| **Small teams** | Easy user management, quick onboarding |
| **Proof of concept** | Get started in minutes, upgrade path available |
| **Air-gapped environments** | No external service dependencies |
| **Development/testing** | Fast iteration, simple reset |

Consider a [standalone external IdP](/selfhosted/selfhosted-guide#step-3-configure-identity-provider-idp) if you need:

- SCIM user provisioning (Enterprise feature)
- Complex user lifecycle management
- Integration with existing enterprise SSO infrastructure
- Specific IdP features not available via OIDC connectors

## Configuration

### Enabling Embedded IdP

The embedded IdP is enabled by default when using the new [`getting-started.sh`](/selfhosted/selfhosted-quickstart) quickstart script. For manual configuration, update your `management.json`:

```json
{
  "EmbeddedIdP": {
    "Enabled": true,
    "DataDir": "/var/lib/netbird/idp"
  },
  "EncryptionKey": "<auto-generated-base64-key>"
}
```

### Configuration Options

| Option | Description | Default |
|--------|-------------|---------|
| `EmbeddedIdP.Enabled` | Enable/disable the embedded IdP | `true` (quickstart) |
| `EmbeddedIdP.DataDir` | Directory for IdP data storage | `/var/lib/netbird/idp` |
| `EncryptionKey` | Base64-encoded AES-256 key for encrypting user data | Auto-generated |

### Environment Variables

When using docker-compose, you can configure these via environment variables:

```yaml
environment:
  - NETBIRD_EMBEDDED_IDP_ENABLED=true
  - NETBIRD_EMBEDDED_IDP_DATA_DIR=/var/lib/netbird/idp
  - NETBIRD_ENCRYPTION_KEY=${ENCRYPTION_KEY}
```

### Generating an Encryption Key

If you need to generate an encryption key manually:

```bash
openssl rand -base64 32
```

<Note>
Store your encryption key securely. If lost, encrypted user data (emails, names) cannot be recovered. Include it in your backup procedures.
</Note>

## User Management

### Inviting Users via Dashboard

You can invite users via a secure invite link, allowing them to set their own password.

<p>
<img src="/docs-static/img/selfhosted/identity-providers/local/invite-user.png" alt="Invite User"  className="imagewrapper"/>
</p>

1. Navigate to **Team** → **Users**
2. Click **Add User**
3. Select the **Invite User** tab
4. Fill in the user details:
   - **Name** (required) - Display name
   - **Email** (required) - User's email address
   - **Role** - User role (User, Admin, etc.)
   - **Expires in** - Number of days until the invite link expires (default: 3 days)
   - **Auto-assigned groups** (optional) - Groups to assign when the user joins
5. Click **Create Invite Link**

After creation, a modal displays:
- The **invite link** that you can share with the user
- The **expiration date** of the invite
- **Copy & Close** button to copy the link

<p>
    <img src="/docs-static/img/selfhosted/identity-providers/local/invite-link.png" alt="Invite Link"  className="imagewrapper"/>
</p>

The invited user can then:
1. Open the invite link in their browser
2. Set their own password
3. Log in to NetBird with their new credentials

<p>
 <img src="/docs-static/img/selfhosted/identity-providers/local/accept-invite.png" alt="Accept User Invite"  className="imagewrapper"/>
</p>

#### Managing Pending Invites

To view and manage pending invites:

1. Navigate to **Team** → **Users**
2. Click **Show Invites** to switch to the invites view

From the invites view, you can:
- **Regenerate** an invite link if it has expired or needs to be resent
- **Delete** an invite to revoke access before it's accepted

<Note>
When an invite link is regenerated, the previous link becomes invalid. Only the new link can be used to complete registration.
</Note>

### Creating Users via Dashboard

As an alternative to inviting users, you can create users with a generated password:

1. Navigate to **Team** → **Users**
2. Click **Add User**
3. Select the **Create User** tab
4. Fill in the user details:
   - **Email** (required) - User's email address for login
   - **Name** (required) - Display name
   - **Groups** (optional) - Auto-assign to groups
5. Click **Create**

After creation, a modal displays with:
- The **generated password** with a copy button
- Warning: *"This password will only be shown once. Please copy it now."*
- **Copy & Close** button to copy password and dismiss

<Note>
The generated password is only shown once at creation time. It cannot be retrieved later. Make sure to copy it and share it securely with the user.
</Note>

### Inviting Users via API

```bash
curl -X POST "https://netbird.example.com/api/users/invites" \
  -H "Authorization: Bearer ${TOKEN}" \
  -H "Content-Type: application/json" \
  -d '{
    "email": "user@example.com",
    "name": "New User",
    "role": "user",
    "auto_groups": ["group-id-1"],
    "expires_in": 259200
  }'
```

The `expires_in` field specifies the invite validity period in seconds (e.g., 259200 = 3 days).

Response:

```json
{
  "id": "invite-abc123",
  "email": "user@example.com",
  "name": "New User",
  "role": "user",
  "invite_link": "abc123-token-xyz",
  "invite_expires_at": "2024-01-10T12:00:00Z",
  "auto_groups": ["group-id-1"]
}
```

Construct the full invite URL by appending the token to your dashboard URL:
```
https://netbird.example.com/invite?token=abc123-token-xyz
```

### Changing User Passwords

The Change Password feature allows local users on self-hosted NetBird deployments to update their account password directly from the dashboard.

<p>
    <img src="/docs-static/img/selfhosted/identity-providers/local/change-password-modal.png" alt="Change Password"  className="imagewrapper"/>
</p>


This feature is available when:
  - The deployment is self-hosted (not NetBird's hosted platform)
  - The user authenticates via local authentication

Users authenticated through SSO/OIDC providers will not see this option.

How to Use:

  1. Click your avatar in the top-right corner of the dashboard
  2. Select "Change Password" from the dropdown menu
  3. Enter your current password to verify your identity
  4. Enter your new password (minimum 8 characters)
  5. Confirm your new password
  6. Click "Change Password" or press Enter

<img src="/docs-static/img/selfhosted/identity-providers/local/change-password-menu.png" alt="Change Password"  className="imagewrapper"/>

Password Requirements

  - Minimum length: eight characters
  - New password and confirmation must match

### User IdP Badges

In the Users table, each user shows a badge indicating their identity provider:
- Users created locally show no badge (or "Local" badge)
- Users who authenticated via an external connector show that provider's icon (Google, Microsoft, etc.)
- The badge links to the `idp_id` field in the user record

### Creating Users via API

```bash
curl -X POST "https://netbird.example.com/api/users" \
  -H "Authorization: Bearer ${TOKEN}" \
  -H "Content-Type: application/json" \
  -d '{
    "email": "user@example.com",
    "name": "New User",
    "auto_groups": ["group-id-1"]
  }'
```

Response includes the generated password:

```json
{
  "id": "user-abc123",
  "email": "user@example.com",
  "name": "New User",
  "role": "user",
  "status": "active",
  "password": "generated-password-here"
}
```

<Note>
The `password` field is only included when creating users with embedded IdP. Store it immediately—it won't be returned in subsequent API calls.
</Note>

### User Roles

Users created through the embedded IdP can be assigned roles:

| Role | Permissions |
|------|-------------|
| **Owner** | Full administrative access, cannot be demoted |
| **Admin** | Manage users, peers, policies, and settings |
| **User** | Connect devices, view assigned resources |

## Instance Setup (First Run)

When NetBird starts with the embedded IdP and no existing accounts, the Dashboard redirects to the `/setup` route and displays the **Instance Setup Wizard**:

1. The Dashboard checks `GET /instance` for `setup_required: true`
2. If setup is required, users are redirected to `/setup`
3. The wizard collects:
   - **Email address** (required)
   - **Password** (required, minimum 8 characters)
   - **Name** (optional)
4. On submit, the owner account is created via `POST /instance/setup`
5. User is redirected to login with the credentials they just created

<Note>
The `/setup` route is unauthenticated and only accessible when `setup_required` is true. Once setup is complete, accessing `/setup` returns a 412 error and redirects to login.
</Note>

### Setup API

For automated deployments, you can complete setup via API:

```bash
# Check if setup is required
curl "https://netbird.example.com/api/instance"

# Response when setup is needed:
{
  "setup_required": true
}

# Complete setup
curl -X POST "https://netbird.example.com/api/instance/setup" \
  -H "Content-Type: application/json" \
  -d '{
    "email": "admin@example.com",
    "password": "securepassword123",
    "name": "Admin User"
  }'

# Response:
{
  "user_id": "user-abc123",
  "account_id": "account-xyz789"
}
```

## Data Encryption

The embedded IdP encrypts sensitive user data at rest:

| Field | Encryption |
|-------|------------|
| Email | AES-256-GCM |
| Name | AES-256-GCM |
| Password | bcrypt hash (via Dex) |

The encryption key is configured in `management.json` and should be:

- Generated using a cryptographically secure random generator
- Stored securely (not in version control)
- Included in backup procedures
- Rotated according to your security policies

## Security Considerations

### Password Requirements

Default password requirements for local users:

- Minimum 8 characters
- No specific complexity requirements (consider your security policy)

### Session Management

- JWT tokens are issued upon successful authentication
- Token expiration follows OIDC best practices
- Device authorization flow available for CLI clients

### Audit Logging

User authentication events are logged in the activity log:

- Login attempts (successful and failed)
- User creation/deletion
- Connector configuration changes

## Troubleshooting

### "Embedded IdP not available" error

Ensure `EmbeddedIdP.Enabled` is `true` in `management.json` and the Management service has been restarted.

### Users can't log in

1. Check Management service logs: `docker compose logs management`
2. Verify the encryption key hasn't changed
3. Confirm the user exists: Check **Team** → **Users** in Dashboard

## Comparison with External IdP

| Feature | Embedded IdP | External IdP |
|---------|--------------|--------------|
| Setup complexity | Minimal | Moderate to High |
| Resource requirements | Low (~1GB RAM) | Higher (2-4GB+ RAM) |
| Additional containers | None | IdP + Database |
| User management | Dashboard/API | External IdP console |
| External SSO | Via connectors | Native |
| SCIM provisioning | Not available | Available (Enterprise) |
| MFA | Via external connectors | Native IdP feature |
| Backup complexity | Single database | Multiple databases |

## Deleting the Default Local Admin User 

If you prefer to delegate all credential storage and authentication to your IdP while still utilizing NetBird's new, simplified IdP connection flow, you can remove the default local user. To do so:

1. Configure an external IdP connector following the [Authentication Guide](/selfhosted/identity-providers).
2. Log out and log in with your new admin account via the external IdP. NetBird will notify you that the user requires approval.
3. Log back in as your original NetBird-local admin and navigate to **Team > Users**. You should see the new IdP user pending approval:

<img src="/docs-static/img/selfhosted/identity-providers/approve_user.png" alt="Approve User" className="imagewrapper-big"/>

4. Approve the request, click on the user, select **Owner** as the role, confirm the ownership transfer, and save.

<img src="/docs-static/img/selfhosted/identity-providers/change-owner.png" alt="Change Owner" className="imagewrapper-big"/>

5. Log out and log back in as the new IdP user. You should now have admin access. Navigate to **Team > Users** and delete the original NetBird-local user. 

## Disabling Embedded IdP

To switch from embedded IdP to a (standalone) external IdP:

1. Configure your external IdP following the [Advanced guide](/selfhosted/selfhosted-guide)
2. Update `management.json`:

   ```json
   {
     "EmbeddedIdP": {
       "Enabled": false
     },
     "HttpConfig": {
       "OIDCConfigEndpoint": "https://your-idp.example.com/.well-known/openid-configuration"
     }
   }
   ```

3. Restart the Management service
4. Users will need to re-authenticate with the new IdP

<Note>
Disabling the embedded IdP will invalidate all local user accounts. Ensure users have accounts in the external IdP before switching.
</Note>

