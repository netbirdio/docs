# Management SQLite store

In NetBird, the Management system traditionally relies on JSON file storage.
Starting from version 0.24.0, we have introduced **experimental** support for SQLite.
This addition aims to provide users with enhanced performance and scalability options.

## SQLite entity relationship diagram

For a high-level overview of the SQLite schema, refer to the Entity Relationship Diagram (ERD) below:

<p>
    <img src="/docs-static/img/selfhosted/sqlite-erd.png" alt="high-level-dia" className="imagewrapper"/>
</p>

## Using SQLite for fresh installations

As of version 0.24.0, the default configuration for fresh installations is JSON file storage. 
However, users have the option to leverage the benefits of SQLite for new instances. 
To enable SQLite, add to your setup.env the following variable:
```bash
NETBIRD_STORE_CONFIG_ENGINE=sqlite
```
This will result in a configuration similar to the following in your management.json file:
```json
    "StoreConfig": {
        "Engine": "sqlite"
    }
```
You can switch back to JSON file storage by setting the `NETBIRD_STORE_CONFIG_ENGINE` variable to `jsonfile`.
<Note>
    Switching between storage options requires migration steps to prevent data loss.
</Note>
## Migration from JSON Store

Starting from version 0.24.0, NetBird Management provides a subcommand to facilitate migration to SQLite. This command is part of the binary shipped within the official docker image.
<Note>
    The following commands assume you use the latest docker version with the compose plugin. If you have docker-compose installed as a standalone, please use docker-compose as a command.
</Note>
```bash
$ docker compose exec management /go/bin/netbird-mgmt sqlite-migration
```
This will produce an output similar to:
```bash
Contains sub-commands to perform JSON file store to SQLite store migration and rollback

Usage:
  netbird-mgmt sqlite-migration [command]

Available Commands:
  downgrade   Rollback SQLite store to JSON file store. Please make a backup of the SQLite file before running this command.
  upgrade     Migrate JSON file store to SQLite store. Please make a backup of the JSON file before running this command.

Flags:
      --datadir string   server data directory location (default "/var/lib/netbird/")
  -h, --help             help for sqlite-migration

Global Flags:
      --log-file string    sets Netbird log path. If console is specified the the log will be output to stdout (default "/var/log/netbird/management.log")
      --log-level string   (default "info")

Use "netbird-mgmt sqlite-migration [command] --help" for more information about a command.
```
## Migrating from JSON store to SQLite
This migration process allows users to seamlessly transition between storage options while maintaining data integrity.
Ensure you perform backups before any migration or rollback operations.

### Follow these steps for migration:
To migrate from JSON file store to SQLite, follow these steps:
<Note>
    The following commands assume you use the latest docker version with the compose plugin. If you have docker-compose installed as a standalone, please use docker-compose as a command.
</Note>
1. Stop NetBird Management service.
```bash
  docker compose stop management
```
2. Backup your data store (`store.json` in `datadir` - default "/var/lib/netbird/").
```bash
  mkdir backup
  docker compose cp -a management:/var/lib/netbird/ backup/
```
3. Start NetBird Management service:
```bash
  docker compose start management
```
4. Run the migration to SQLite subcommand:
```bash
  docker compose start management /go/bin/netbird-mgmt sqlite-migration upgrade --log-file console
```
5. Enable SQLite by updating the management.json file and setting the `Engine` field to `sqlite` as the following example:
```json
    "StoreConfig": {
        "Engine": "sqlite"
    }
```
6. Restart the Management service.
```bash
  docker compose restart management
```

### Rollback to JSON file store
To rollback to the JSON file store, follow these steps:
<Note>
    The following commands assume you use the latest docker version with the compose plugin. If you have docker-compose installed as a standalone, please use docker-compose as a command.
</Note>
1. Stop NetBird Management service.
```bash
  docker compose stop management
```
2. Backup your data store (`store.db` in `datadir` - default "/var/lib/netbird/").
```bash
  mkdir backup
  docker compose cp -a management:/var/lib/netbird/ backup/
```
3. Start NetBird Management service:
```bash
  docker compose start management
```
4. Run the migration to SQLite subcommand:
```bash
  docker compose start management /go/bin/netbird-mgmt sqlite-migration downgrade --log-file console
```
5. Enable JSON file by updating the management.json file and setting the `Engine` field to `jsonfile` as the following example:
```json
    "StoreConfig": {
        "Engine": "jsonfile
    }
```
6. Restart the Management service.
```bash
  docker compose restart management
```